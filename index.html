<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Finder (Stable)</title>
    <!-- Preact & htm (Native ESM, no Babel needed) -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">

    <!-- Load Local Config -->
    <script src="config.js"></script>

    <style>
        :root {
            --primary-color: #e50914;
            --secondary-color: #ffffff;
            --background-color: #141414;
            --text-color: #e5e5e5;
            --card-bg: #1f1f1f;
            --font-family: 'Inter', system-ui, Avenir, Helvetica, Arial, sans-serif;
            --transition-speed: 0.3s;
        }

        body {
            margin: 0;
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #root {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid #333;
        }

        h1 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--primary-color);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            width: 100%;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 2rem;
        }

        .movie-card {
            background-color: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            transition: transform var(--transition-speed), box-shadow var(--transition-speed);
            cursor: pointer;
            position: relative;
        }

        .movie-card:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        .movie-poster {
            width: 100%;
            aspect-ratio: 2/3;
            object-fit: cover;
        }

        .movie-info {
            padding: 1rem;
        }

        .movie-title {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .movie-rating {
            font-size: 0.85rem;
            color: #bbb;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .search-container {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .search-input {
            width: 100%;
            max-width: 500px;
            padding: 1rem 1.5rem;
            border-radius: 50px;
            border: none;
            background-color: #333;
            color: white;
            font-size: 1rem;
            transition: background-color var(--transition-speed);
        }

        .search-input:focus {
            outline: none;
            background-color: #444;
            box-shadow: 0 0 0 2px var(--primary-color);
        }

        .btn {
            padding: 0.5rem 1rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color var(--transition-speed);
        }

        .btn:hover {
            background-color: #b20710;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: 8px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            z-index: 10;
        }

        .modal-body {
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 768px) {
            .modal-body {
                flex-direction: row;
            }
        }

        .modal-poster {
            width: 100%;
            max-width: 300px;
            object-fit: cover;
            margin: 0 auto;
        }

        .modal-details {
            padding: 2rem;
        }

        .modal-meta {
            display: flex;
            gap: 1rem;
            color: #bbb;
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }

        .modal-overview {
            line-height: 1.6;
            font-size: 1.1rem;
        }

        .gateway-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('https://assets.nflxext.com/ffe/siteui/vlv3/f841d4c7-10e1-40af-bcae-07a3f8dc141a/f6d7434e-d6de-4185-a6d4-c77a2d08648f/US-en-20220502-popsignuptwoweeks-perspective_alpha_website_medium.jpg');
            background-size: cover;
            background-position: center;
        }

        .gateway-card {
            background-color: rgba(0, 0, 0, 0.85);
            padding: 3rem;
            border-radius: 10px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .error-message {
            color: #e50914;
            margin-top: 1rem;
            font-weight: bold;
        }

        .connect-btn {
            margin-top: 2rem;
            font-size: 1.2rem;
            padding: 1rem 2rem;
        }

        .install-link {
            margin-top: 2rem;
            font-size: 0.9rem;
        }

        .install-link a {
            color: #e50914;
            text-decoration: none;
        }

        .install-link a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="module">
        import { h, render } from 'https://esm.sh/preact';
        import { useState, useEffect } from 'https://esm.sh/preact/hooks';
        import htm from 'https://esm.sh/htm';

        const html = htm.bind(h);

        // --- CONFIGURATION ---
        const API_KEY = (window.env && window.env.API_KEY) ? window.env.API_KEY : "";
        const BASE_URL = 'https://api.themoviedb.org/3';

        // --- MOCK DATA ---
        const mockMovies = [
            {
                id: 1,
                title: "Inception",
                overview: "Cobb, a skilled thief who commits corporate espionage by infiltrating the subconscious of his targets.",
                poster_path: "/9gk7adHYeDvHkCSEqAvQNLV5Uge.jpg",
                vote_average: 8.8,
                release_date: "2010-07-15"
            },
            {
                id: 2,
                title: "The Dark Knight",
                overview: "Batman raises the stakes in his war on crime.",
                poster_path: "/qJ2tW6WMUDux911r6m7haRef0WH.jpg",
                vote_average: 8.5,
                release_date: "2008-07-14"
            }
        ];

        // --- API FUNCTIONS ---
        const getPopularMovies = async (page = 1) => {
            if (!API_KEY) return mockMovies;
            try {
                const response = await fetch(`${BASE_URL}/movie/popular?api_key=${API_KEY}&language=en-US&page=${page}`);
                const data = await response.json();
                return data.results || mockMovies;
            } catch { return mockMovies; }
        };

        const searchMovies = async (query, page = 1) => {
            if (!API_KEY) return mockMovies.filter(m => m.title.toLowerCase().includes(query.toLowerCase()));
            try {
                const response = await fetch(`${BASE_URL}/search/movie?api_key=${API_KEY}&language=en-US&query=${encodeURIComponent(query)}&page=${page}`);
                const data = await response.json();
                return data.results || [];
            } catch { return []; }
        };

        // --- COMPONENTS ---
        const MovieCard = ({ movie, onSelect }) => {
            const imageUrl = movie.poster_path ? `https://image.tmdb.org/t/p/w500${movie.poster_path}` : 'https://via.placeholder.com/500x750?text=No+Image';
            return html`
                <div class="movie-card" onClick=${() => onSelect(movie)}>
                    <img src=${imageUrl} alt=${movie.title} class="movie-poster" />
                    <div class="movie-info">
                        <h3 class="movie-title">${movie.title}</h3>
                        <span class="movie-rating">‚≠ê ${movie.vote_average ? movie.vote_average.toFixed(1) : 'N/A'}</span>
                    </div>
                </div>
            `;
        };

        const SearchBar = ({ onSearch }) => {
            const [query, setQuery] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); onSearch(query); };
            return html`
                <form class="search-container" onSubmit=${handleSubmit}>
                    <input type="text" class="search-input" placeholder="Search for movies..." value=${query} onInput=${(e) => setQuery(e.target.value)} />
                </form>
            `;
        };

        const WalletGateway = ({ onConnect }) => {
            const [error, setError] = useState('');
            const connectWallet = async () => {
                if (typeof window.ethereum !== 'undefined') {
                    try {
                        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                        if (accounts.length > 0) onConnect(accounts[0]);
                    } catch { setError('Connection failed.'); }
                } else { setError('MetaMask not detected!'); }
            };
            return html`
                <div class="gateway-container">
                    <div class="gateway-card">
                        <h2>üîí Access Restricted</h2>
                        <p>Please connect your Ethereum wallet to access the Movie Finder.</p>
                        ${error && html`<div class="error-message">${error}</div>`}
                        <button class="btn connect-btn" onClick=${connectWallet}>Connect Wallet</button>
                    </div>
                </div>
            `;
        };

        function App() {
            const [userAccount, setUserAccount] = useState(null);
            const [movies, setMovies] = useState([]);
            const [selectedMovie, setSelectedMovie] = useState(null);
            const [loading, setLoading] = useState(true);
            const [page, setPage] = useState(1);
            const [searchQuery, setSearchQuery] = useState('');

            useEffect(() => {
                if (typeof window.ethereum !== 'undefined') {
                    window.ethereum.request({ method: 'eth_accounts' }).then(accs => accs[0] && setUserAccount(accs[0]));
                }
            }, []);

            useEffect(() => { if (userAccount) loadMovies(); }, [userAccount]);

            const loadMovies = async (pageToLoad = 1) => {
                setLoading(true);
                const results = await getPopularMovies(pageToLoad);
                setMovies(pageToLoad === 1 ? results : [...movies, ...results]);
                setLoading(false);
            };

            const handleSearch = async (query) => {
                setSearchQuery(query);
                setPage(1);
                setLoading(true);
                const results = query.trim() ? await searchMovies(query, 1) : await getPopularMovies(1);
                setMovies(results);
                setLoading(false);
            };

            const loadMore = async () => {
                const nextPage = page + 1;
                setPage(nextPage);
                setLoading(true);
                const results = searchQuery.trim() ? await searchMovies(searchQuery, nextPage) : await getPopularMovies(nextPage);
                setMovies([...movies, ...results]);
                setLoading(false);
            };

            if (!userAccount) return html`<${WalletGateway} onConnect=${setUserAccount} />`;

            return html`
                <div class="app">
                    <header>
                        <h1>Movie Finder</h1>
                        <div style="font-size: 0.8rem; color: #888">Connected: ${userAccount.slice(0, 6)}...${userAccount.slice(-4)}</div>
                    </header>
                    <main class="container">
                        <${SearchBar} onSearch=${handleSearch} />
                        <div class="grid">
                            ${movies.map(m => html`<${MovieCard} key=${m.id} movie=${m} onSelect=${setSelectedMovie} />`)}
                        </div>
                        ${movies.length > 0 && html`
                            <div style="display: flex; justify-content: center; margin-top: 2rem;">
                                <button class="btn" onClick=${loadMore} disabled=${loading}>${loading ? 'Loading...' : 'Load More'}</button>
                            </div>
                        `}
                    </main>
                    ${selectedMovie && html`
                        <div class="modal-overlay" onClick=${() => setSelectedMovie(null)}>
                            <div class="modal-content" onClick=${e => e.stopPropagation()}>
                                <button class="close-btn" onClick=${() => setSelectedMovie(null)}>&times;</button>
                                <div class="modal-body">
                                    <img src=${selectedMovie.poster_path ? 'https://image.tmdb.org/t/p/w500' + selectedMovie.poster_path : ''} class="modal-poster" />
                                    <div class="modal-details">
                                        <h2>${selectedMovie.title}</h2>
                                        <p class="modal-meta"><span>${selectedMovie.release_date}</span> <span>‚≠ê ${selectedMovie.vote_average}</span></p>
                                        <p class="modal-overview">${selectedMovie.overview}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

        render(html`<${App} />`, document.getElementById('root'));
    </script>
</body>

</html>
